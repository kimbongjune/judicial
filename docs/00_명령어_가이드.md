# 명령어 가이드

## 1. Conda 환경 관리

### 1.1 환경 생성 및 관리

```bash
# 환경 생성 (environment.yml 사용)
conda env create -f environment.yml

# 환경 활성화
conda activate judicial

# 환경 비활성화
conda deactivate

# 환경 목록 확인
conda env list

# 환경 삭제
conda env remove -n judicial

# 환경 업데이트 (environment.yml 변경 후)
conda env update -f environment.yml --prune

# 환경 내보내기
conda env export > environment.yml
```

### 1.2 패키지 관리

```bash
# 패키지 설치
conda install <package-name>
pip install <package-name>

# 패키지 목록 확인
conda list
pip list

# 패키지 업데이트
conda update <package-name>
pip install --upgrade <package-name>

# 패키지 삭제
conda remove <package-name>
pip uninstall <package-name>
```

---

## 2. 개발 서버 실행

### 2.1 FastAPI 개발 서버

```bash
# 환경 활성화 필수
conda activate judicial

# 개발 서버 (자동 리로드)
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 특정 포트로 실행
uvicorn app.main:app --reload --port 3000

# 워커 수 지정 (프로덕션)
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

### 2.2 접속 URL

| 용도 | URL |
|------|-----|
| 메인 페이지 | http://localhost:8000 |
| API 문서 (Swagger) | http://localhost:8000/api/docs |
| API 문서 (ReDoc) | http://localhost:8000/api/redoc |
| 헬스체크 | http://localhost:8000/health |

---

## 3. 데이터베이스 관리

### 3.1 초기화

```bash
# 테이블 생성
python scripts/init_db.py

# 테이블 삭제 후 재생성
python scripts/init_db.py --drop-all

# 마이그레이션 (Alembic 사용 시)
alembic upgrade head
alembic downgrade -1
```

### 3.2 SQLite 접속

```bash
# SQLite CLI 접속
sqlite3 data/judicial.db

# 테이블 목록 확인
.tables

# 테이블 스키마 확인
.schema cases

# 레코드 수 확인
SELECT COUNT(*) FROM cases;

# 종료
.quit
```

### 3.3 PostgreSQL 접속

```bash
# PostgreSQL CLI 접속
psql -U judicial_user -d judicial

# 테이블 목록
\dt

# 테이블 스키마
\d cases

# 종료
\q
```

---

## 4. ETL (데이터 수집)

### 4.1 판례 수집

```bash
# 전체 판례 수집 (시간 소요: 약 24시간)
python scripts/run_etl.py --target prec

# 제한된 개수만 수집 (테스트용)
python scripts/run_etl.py --target prec --limit 1000

# 특정 기간 판례 수집
python scripts/run_etl.py --target prec --from-date 2023-01-01 --to-date 2023-12-31

# 증분 업데이트 (마지막 수집 이후 신규분만)
python scripts/run_etl.py --target prec --incremental

# 대법원 판례만 수집
python scripts/run_etl.py --target prec --court 400201
```

### 4.2 헌재결정례 수집

```bash
# 전체 헌재결정례 수집
python scripts/run_etl.py --target detc

# 제한된 개수만
python scripts/run_etl.py --target detc --limit 500
```

### 4.3 법령해석례 수집

```bash
# 전체 법령해석례 수집
python scripts/run_etl.py --target expc

# 제한된 개수만
python scripts/run_etl.py --target expc --limit 500
```

### 4.4 전체 수집

```bash
# 모든 데이터 수집 (판례 + 헌재결정례 + 법령해석례)
python scripts/run_etl.py --target all --limit 1000
```

---

## 5. 임베딩 및 인덱스

### 5.1 임베딩 생성

```bash
# 모든 문서 임베딩 생성
python scripts/build_index.py

# 판례만 임베딩
python scripts/build_index.py --target cases

# 배치 크기 조정 (메모리 부족 시)
python scripts/build_index.py --batch-size 32
```

### 5.2 FAISS 인덱스 관리

```bash
# 인덱스 생성
python scripts/build_index.py --build

# 인덱스 재생성
python scripts/build_index.py --rebuild

# 인덱스 상태 확인
python scripts/build_index.py --status
```

---

## 6. 테스트

### 6.1 테스트 실행

```bash
# 전체 테스트
pytest

# 상세 출력
pytest -v

# 특정 테스트 파일
pytest tests/test_api/test_cases.py

# 특정 테스트 함수
pytest tests/test_api/test_cases.py::test_search_cases

# 커버리지 측정
pytest --cov=app --cov-report=html

# 실패한 테스트만 재실행
pytest --lf
```

### 6.2 API 테스트

```bash
# curl로 API 테스트
curl http://localhost:8000/api/v1/cases/search?q=손해배상

# POST 요청
curl -X POST http://localhost:8000/api/v1/cases/search/semantic \
  -H "Content-Type: application/json" \
  -d '{"query": "층간소음 손해배상", "top_k": 10}'
```

---

## 7. 코드 품질

### 7.1 포맷팅

```bash
# Black으로 포맷팅
black app/ etl/ ml/ scripts/

# 특정 파일만
black app/main.py

# 체크만 (변경 없음)
black --check app/
```

### 7.2 린트

```bash
# Ruff 린트
ruff check app/ etl/ ml/

# 자동 수정
ruff check --fix app/

# 특정 규칙 무시
ruff check --ignore E501 app/
```

### 7.3 타입 체크

```bash
# mypy 타입 체크
mypy app/
```

---

## 8. 유틸리티 명령어

### 8.1 캐시 정리

```bash
# Python 캐시 삭제
find . -type d -name "__pycache__" -exec rm -rf {} +
find . -type f -name "*.pyc" -delete

# pytest 캐시 삭제
rm -rf .pytest_cache

# ruff 캐시 삭제
rm -rf .ruff_cache
```

### 8.2 로그 확인

```bash
# 앱 로그
tail -f logs/app.log

# ETL 로그
tail -f logs/etl.log

# 에러만 필터
grep ERROR logs/app.log
```

### 8.3 디스크 사용량

```bash
# 데이터 디렉토리 크기
du -sh data/

# FAISS 인덱스 크기
du -sh data/faiss/

# SQLite DB 크기
du -sh data/judicial.db
```

---

## 9. 자주 쓰는 명령어 조합

### 9.1 개발 시작

```bash
# 1. 환경 활성화
conda activate judicial

# 2. 서버 실행
uvicorn app.main:app --reload
```

### 9.2 데이터 초기화 및 수집

```bash
# 1. DB 초기화
python scripts/init_db.py

# 2. 데이터 수집 (테스트용)
python scripts/run_etl.py --target all --limit 100

# 3. 인덱스 생성
python scripts/build_index.py
```

### 9.3 커밋 전 체크

```bash
# 포맷팅 + 린트 + 테스트
black app/ && ruff check app/ && pytest
```

---

## 10. 환경변수

### 10.1 현재 환경변수 확인

```bash
# 모든 환경변수
env | grep -E "^(LAW_|DATABASE_|APP_)"

# 특정 변수
echo $LAW_API_OC
echo $DATABASE_URL
```

### 10.2 임시 환경변수 설정

```bash
# 일회성 설정 후 실행
LAW_API_OC=nocdu112 python scripts/run_etl.py

# 세션 동안 유지
export LAW_API_OC=nocdu112
```

---

## 11. 트러블슈팅 명령어

### 11.1 포트 충돌

```bash
# 8000 포트 사용 중인 프로세스 확인
lsof -i :8000

# 프로세스 종료
kill -9 <PID>
```

### 11.2 Conda 환경 문제

```bash
# 환경 재생성
conda deactivate
conda env remove -n judicial
conda env create -f environment.yml
conda activate judicial
```

### 11.3 패키지 의존성 문제

```bash
# 의존성 캐시 삭제
pip cache purge
conda clean --all

# 패키지 재설치
pip install -r requirements.txt --force-reinstall
```
