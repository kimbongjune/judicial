# 시스템 아키텍처

## 1. 개요

본 문서는 법률 판례 검색 시스템의 전체 아키텍처를 설명합니다.

---

## 2. 전체 시스템 구성도

```mermaid
graph TB
    subgraph Client["클라이언트"]
        Browser[웹 브라우저]
    end

    subgraph Server["애플리케이션 서버"]
        subgraph WebLayer["웹 레이어"]
            FastAPI[FastAPI App]
            Jinja2[Jinja2 Templates]
        end

        subgraph ServiceLayer["서비스 레이어"]
            SearchService[Search Service]
            CaseService[Case Service]
            EmbeddingService[Embedding Service]
        end

        subgraph MLLayer["ML 레이어"]
            SentenceTransformer[Sentence Transformers]
            FAISS[FAISS Index]
        end
    end

    subgraph DataLayer["데이터 레이어"]
        PostgreSQL[(PostgreSQL)]
        FAISSFile[(FAISS Index Files)]
    end

    subgraph ETLLayer["ETL 레이어"]
        ETLScheduler[APScheduler]
        ETLPipeline[ETL Pipeline]
    end

    subgraph External["외부 시스템"]
        LawAPI[법제처 OpenAPI]
    end

    Browser -->|HTTP/HTTPS| FastAPI
    FastAPI --> Jinja2
    FastAPI --> SearchService
    FastAPI --> CaseService
    
    SearchService --> EmbeddingService
    SearchService --> PostgreSQL
    
    CaseService --> PostgreSQL
    
    EmbeddingService --> SentenceTransformer
    EmbeddingService --> FAISS
    
    FAISS --> FAISSFile
    
    ETLScheduler --> ETLPipeline
    ETLPipeline -->|API Call| LawAPI
    ETLPipeline -->|Insert/Update| PostgreSQL
    ETLPipeline -->|Build Index| FAISS
```

---

## 3. 레이어 아키텍처

```mermaid
graph TB
    subgraph Presentation["프레젠테이션 레이어"]
        Templates[Jinja2 Templates]
        StaticFiles[Static Files]
        APIRoutes[API Routes]
    end

    subgraph Application["애플리케이션 레이어"]
        SearchSvc[검색 서비스]
        CaseSvc[판례 서비스]
        EmbedSvc[임베딩 서비스]
        FilterSvc[필터 서비스]
    end

    subgraph Domain["도메인 레이어"]
        CaseModel[Case Model]
        SearchModel[Search Model]
        EmbeddingModel[Embedding Model]
    end

    subgraph Infrastructure["인프라 레이어"]
        Repository[Repository]
        FAISSAdapter[FAISS Adapter]
        ExternalAPI[External API Client]
    end

    subgraph DataStore["데이터 저장소"]
        DB[(Database)]
        VectorDB[(Vector Index)]
    end

    Presentation --> Application
    Application --> Domain
    Application --> Infrastructure
    Infrastructure --> DataStore
```

---

## 4. 컴포넌트 다이어그램

```mermaid
graph LR
    subgraph app["app/"]
        main[main.py]
        config[config.py]
        database[database.py]
        
        subgraph api["api/"]
            casesAPI[cases.py]
            searchAPI[search.py]
            similarAPI[similar.py]
            filtersAPI[filters.py]
        end
        
        subgraph services["services/"]
            caseService[case_service.py]
            searchService[search_service.py]
            embeddingService[embedding_service.py]
        end
        
        subgraph models["models/"]
            caseModel[case.py]
            embeddingModel[embedding.py]
        end
        
        subgraph schemas["schemas/"]
            caseSchema[case.py]
            searchSchema[search.py]
        end
    end

    subgraph etl["etl/"]
        apiClient[api_client.py]
        extractor[extractors/]
        transformer[transformers/]
        loader[loaders/]
    end

    subgraph ml["ml/"]
        embedder[embedder.py]
        faissIndex[faiss_index.py]
    end

    main --> api
    api --> services
    services --> models
    services --> ml
    models --> database
```

---

## 5. 데이터 흐름도

### 5.1 검색 요청 흐름

```mermaid
sequenceDiagram
    participant User as 사용자
    participant Web as FastAPI
    participant Search as SearchService
    participant Embed as EmbeddingService
    participant FAISS as FAISS Index
    participant DB as PostgreSQL

    User->>Web: 검색 요청 (자연어)
    Web->>Search: search_semantic(query)
    Search->>Embed: encode(query)
    Embed->>Embed: Sentence Transformer
    Embed-->>Search: query_vector (768D)
    Search->>FAISS: search(vector, top_k)
    FAISS-->>Search: [(faiss_id, distance)]
    Search->>DB: SELECT * FROM cases WHERE embedding_id IN (...)
    DB-->>Search: cases[]
    Search-->>Web: SearchResult
    Web-->>User: HTML (검색 결과 페이지)
```

### 5.2 판례 상세 조회 흐름

```mermaid
sequenceDiagram
    participant User as 사용자
    participant Web as FastAPI
    participant Case as CaseService
    participant Embed as EmbeddingService
    participant DB as PostgreSQL
    participant FAISS as FAISS Index

    User->>Web: GET /cases/{id}
    Web->>Case: get_case_detail(id)
    Case->>DB: SELECT * FROM cases WHERE id = ?
    DB-->>Case: case
    Case->>DB: SELECT * FROM case_reference_* WHERE case_id = ?
    DB-->>Case: references
    Case->>Embed: get_similar_cases(case_id)
    Embed->>DB: SELECT faiss_index_id FROM case_embeddings
    DB-->>Embed: faiss_id
    Embed->>FAISS: search(vector, 10)
    FAISS-->>Embed: similar_ids
    Embed->>DB: SELECT * FROM cases WHERE ...
    DB-->>Embed: similar_cases
    Embed-->>Case: similar_cases
    Case-->>Web: CaseDetail
    Web-->>User: HTML (상세 페이지)
```

### 5.3 ETL 데이터 흐름

```mermaid
sequenceDiagram
    participant Scheduler as APScheduler
    participant ETL as ETL Pipeline
    participant API as 법제처 API
    participant Transform as Transformer
    participant DB as PostgreSQL
    participant Embed as Embedder
    participant FAISS as FAISS Index

    Scheduler->>ETL: trigger job (daily)
    ETL->>API: GET /lawSearch.do?target=prec
    API-->>ETL: case_list (XML)
    
    loop 각 판례
        ETL->>API: GET /lawService.do?ID={serial}
        API-->>ETL: case_detail (XML)
        ETL->>Transform: parse_and_clean(xml)
        Transform-->>ETL: case_data
        ETL->>DB: INSERT/UPDATE cases
        ETL->>Embed: generate_embedding(text)
        Embed-->>ETL: vector (768D)
        ETL->>FAISS: add_vector(vector)
    end
    
    ETL->>FAISS: save_index()
    ETL->>DB: UPDATE etl_job_logs
```

---

## 6. 배포 아키텍처

### 6.1 단일 서버 배포 (개발/소규모)

```mermaid
graph TB
    subgraph Server["단일 서버"]
        subgraph Process["Python Process"]
            Uvicorn[Uvicorn ASGI]
            FastAPI[FastAPI App]
            Services[Services]
            ML[ML Models]
        end
        
        subgraph Data["데이터"]
            PostgreSQL[(PostgreSQL)]
            FAISSFiles[(FAISS Files)]
            StaticFiles[(Static Files)]
        end
    end

    Internet((Internet)) -->|HTTP:8000| Uvicorn
    Uvicorn --> FastAPI
    FastAPI --> Services
    Services --> PostgreSQL
    Services --> ML
    ML --> FAISSFiles
```

### 6.2 배포 구성

```
┌─────────────────────────────────────────────────────────────┐
│                        Linux Server                          │
│  (Ubuntu 22.04+ / RAM: 16GB+ / Storage: 50GB+)             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Nginx     │  │  Uvicorn    │  │    PostgreSQL       │ │
│  │ (Reverse    │──│  (ASGI)     │──│    (Database)       │ │
│  │  Proxy)     │  │  :8000      │  │    :5432            │ │
│  │  :80/:443   │  │             │  │                     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
│         │                │                                  │
│         │         ┌──────┴──────┐                          │
│         │         │             │                          │
│  ┌──────┴──────┐  │  ┌──────────┴──────────┐              │
│  │   Static    │  │  │  FAISS Index Files  │              │
│  │   Files     │  │  │  /data/faiss/       │              │
│  │  /static/   │  │  └─────────────────────┘              │
│  └─────────────┘  │                                        │
│                   │  ┌─────────────────────┐              │
│                   │  │  Sentence-          │              │
│                   └──│  Transformers       │              │
│                      │  (In-Memory)        │              │
│                      └─────────────────────┘              │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Cron Jobs / APScheduler                             │   │
│  │  - Daily ETL: 02:00 AM                              │   │
│  │  - Weekly Full Sync: Sunday 03:00 AM                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 모듈 상세 설계

### 7.1 FastAPI 앱 구조

```python
# app/main.py

from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates

from app.api import cases, search, similar, filters, admin
from app.core.config import settings
from app.core.events import startup_handler, shutdown_handler

app = FastAPI(
    title="법률 판례 검색 시스템",
    version="1.0.0",
    docs_url="/api/docs",
    redoc_url="/api/redoc"
)

# 이벤트 핸들러
app.add_event_handler("startup", startup_handler)
app.add_event_handler("shutdown", shutdown_handler)

# 정적 파일
app.mount("/static", StaticFiles(directory="static"), name="static")

# API 라우터
app.include_router(cases.router, prefix="/api/v1/cases", tags=["cases"])
app.include_router(search.router, prefix="/api/v1/search", tags=["search"])
app.include_router(similar.router, prefix="/api/v1/similar", tags=["similar"])
app.include_router(filters.router, prefix="/api/v1/filters", tags=["filters"])
app.include_router(admin.router, prefix="/api/v1/admin", tags=["admin"])

# SSR 페이지 라우터
from app.pages import pages_router
app.include_router(pages_router)
```

### 7.2 서비스 레이어 구조

```python
# app/services/search_service.py

from typing import List, Optional
from sqlalchemy.orm import Session
from app.models.case import Case
from app.services.embedding_service import EmbeddingService
from app.schemas.search import SearchRequest, SearchResult

class SearchService:
    def __init__(self, db: Session, embedding_service: EmbeddingService):
        self.db = db
        self.embedding_service = embedding_service
    
    async def keyword_search(
        self,
        query: str,
        filters: Optional[dict] = None,
        page: int = 1,
        size: int = 20
    ) -> SearchResult:
        """키워드 기반 검색"""
        pass
    
    async def semantic_search(
        self,
        query: str,
        top_k: int = 10,
        threshold: float = 0.3,
        filters: Optional[dict] = None
    ) -> SearchResult:
        """의미론적 유사도 검색"""
        # 1. 쿼리 임베딩 생성
        query_vector = await self.embedding_service.encode(query)
        
        # 2. FAISS 검색
        results = await self.embedding_service.search(query_vector, top_k)
        
        # 3. 필터 적용 및 결과 반환
        pass
```

### 7.3 임베딩 서비스 구조

```python
# app/services/embedding_service.py

import numpy as np
from sentence_transformers import SentenceTransformer
import faiss
from typing import List, Tuple

class EmbeddingService:
    def __init__(self, model_name: str = "jhgan/ko-sroberta-multitask"):
        self.model = SentenceTransformer(model_name)
        self.index: faiss.Index = None
        self.index_to_id: dict = {}  # faiss_id -> case_id 매핑
    
    def load_index(self, index_path: str):
        """FAISS 인덱스 로드"""
        self.index = faiss.read_index(index_path)
    
    def encode(self, text: str) -> np.ndarray:
        """텍스트를 벡터로 변환"""
        return self.model.encode(text, convert_to_numpy=True)
    
    def batch_encode(self, texts: List[str]) -> np.ndarray:
        """배치 임베딩"""
        return self.model.encode(texts, convert_to_numpy=True, batch_size=32)
    
    def search(
        self,
        query_vector: np.ndarray,
        top_k: int = 10
    ) -> List[Tuple[int, float]]:
        """유사 벡터 검색"""
        query_vector = query_vector.reshape(1, -1).astype('float32')
        distances, indices = self.index.search(query_vector, top_k)
        
        results = []
        for dist, idx in zip(distances[0], indices[0]):
            if idx != -1:  # 유효한 결과만
                case_id = self.index_to_id.get(idx)
                similarity = 1 - dist  # distance to similarity
                results.append((case_id, similarity))
        
        return results
```

---

## 8. 기술 스택 상세

### 8.1 백엔드

| 컴포넌트 | 기술 | 버전 | 용도 |
|----------|------|------|------|
| 웹 프레임워크 | FastAPI | 0.100+ | REST API, SSR |
| ASGI 서버 | Uvicorn | 0.23+ | 비동기 서버 |
| ORM | SQLAlchemy | 2.0+ | DB 접근 |
| 검증 | Pydantic | 2.0+ | 데이터 검증 |
| 템플릿 | Jinja2 | 3.1+ | SSR 렌더링 |

### 8.2 ML/AI

| 컴포넌트 | 기술 | 버전 | 용도 |
|----------|------|------|------|
| 임베딩 | Sentence Transformers | 2.2+ | 텍스트 벡터화 |
| 벡터 검색 | FAISS (CPU) | 1.7+ | 유사도 검색 |
| 딥러닝 | PyTorch | 2.0+ | 모델 추론 |
| 변환 | Transformers | 4.30+ | 모델 로딩 |

### 8.3 데이터베이스

| 컴포넌트 | 기술 | 버전 | 용도 |
|----------|------|------|------|
| RDBMS | PostgreSQL | 15+ | 메인 DB |
| 대안 | SQLite | 3.40+ | 경량 대안 |

### 8.4 프론트엔드

| 컴포넌트 | 기술 | 용도 |
|----------|------|------|
| CSS | TailwindCSS | 스타일링 |
| JS | Alpine.js | 인터랙션 |
| JavaScript | Alpine.js | 클라이언트 상호작용 |

---

## 9. 성능 최적화 전략

### 9.1 캐싱

```mermaid
graph LR
    Request[요청] --> Cache{캐시 확인}
    Cache -->|Hit| CachedResult[캐시된 결과]
    Cache -->|Miss| Process[처리]
    Process --> Store[캐시 저장]
    Store --> Result[결과]
```

| 캐싱 대상 | 저장소 | TTL |
|-----------|--------|-----|
| 검색 결과 | 메모리 (LRU) | 5분 |
| 필터 옵션 | 메모리 | 1시간 |
| 임베딩 모델 | 메모리 | 영구 |
| FAISS 인덱스 | 메모리 | 영구 |

### 9.2 비동기 처리

```python
# 비동기 DB 쿼리
async def get_cases(db: AsyncSession, ids: List[int]) -> List[Case]:
    result = await db.execute(
        select(Case).where(Case.id.in_(ids))
    )
    return result.scalars().all()

# 병렬 처리
async def search_with_details(query: str):
    # 검색과 필터 옵션을 병렬로 조회
    search_task = asyncio.create_task(search_cases(query))
    filter_task = asyncio.create_task(get_filter_options())
    
    search_result, filters = await asyncio.gather(search_task, filter_task)
    return {"results": search_result, "filters": filters}
```

### 9.3 데이터베이스 최적화

- 인덱스 최적화 (복합 인덱스, 부분 인덱스)
- Connection Pooling (SQLAlchemy pool)
- 쿼리 최적화 (Eager Loading)

---

## 10. 보안 설계

### 10.1 입력 검증

```python
from pydantic import BaseModel, Field, validator

class SearchRequest(BaseModel):
    query: str = Field(..., min_length=1, max_length=500)
    
    @validator('query')
    def sanitize_query(cls, v):
        # XSS 방지
        import html
        return html.escape(v)
```

### 10.2 Rate Limiting

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.get("/api/v1/search")
@limiter.limit("30/minute")
async def search(request: Request):
    pass
```

### 10.3 CORS 설정

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://yourdomain.com"],
    allow_methods=["GET", "POST"],
    allow_headers=["*"],
)
```

---

## 11. 모니터링 및 로깅

### 11.1 로깅 구조

```python
import logging
import json
from datetime import datetime

class JSONFormatter(logging.Formatter):
    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
        }
        if hasattr(record, 'extra'):
            log_data.update(record.extra)
        return json.dumps(log_data)
```

### 11.2 메트릭 수집

| 메트릭 | 설명 |
|--------|------|
| request_count | 요청 수 |
| request_latency | 응답 시간 |
| search_queries | 검색 쿼리 수 |
| embedding_time | 임베딩 소요 시간 |
| faiss_search_time | FAISS 검색 시간 |
| db_query_time | DB 쿼리 시간 |

---

## 12. 환경 설정

### 12.1 환경 변수

```bash
# .env

# 애플리케이션
APP_NAME=judicial-search
APP_ENV=development
DEBUG=true

# 데이터베이스
DATABASE_URL=postgresql://user:pass@localhost:5432/judicial

# 법제처 API
LAW_API_KEY=your-api-key-here
LAW_API_BASE_URL=http://www.law.go.kr/DRF

# ML 모델
EMBEDDING_MODEL=jhgan/ko-sroberta-multitask
FAISS_INDEX_PATH=./data/faiss/index.faiss

# ETL
ETL_BATCH_SIZE=100
ETL_RATE_LIMIT=10  # requests per second
```

### 12.2 설정 클래스

```python
# app/core/config.py

from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    app_name: str = "judicial-search"
    app_env: str = "development"
    debug: bool = False
    
    database_url: str
    
    law_api_key: str
    law_api_base_url: str = "http://www.law.go.kr/DRF"
    
    embedding_model: str = "jhgan/ko-sroberta-multitask"
    faiss_index_path: str = "./data/faiss/index.faiss"
    
    etl_batch_size: int = 100
    etl_rate_limit: int = 10
    
    class Config:
        env_file = ".env"

settings = Settings()
```
